<!DOCTYPE html>
<html>
  <head>
    <title>Stock Dashboard</title>
    <meta charset="utf-8" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }
        h1 {
            color: white;
            text-align: center;
            font-size: 3em;
            margin-bottom: 40px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
            letter-spacing: -1px;
        }
        table {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            border-collapse: separate;
            border-spacing: 0 15px;
        }
        thead tr {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
        }
        th {
            color: white;
            padding: 20px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 1px;
            border: none;
        }
        th:first-child {
            border-radius: 10px 0 0 10px;
        }
        th:last-child {
            border-radius: 0 10px 10px 0;
        }
        tbody tr {
            background: white;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border-radius: 10px;
        }
        tbody tr:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
        }
        td {
            padding: 25px 20px;
            border: none;
        }
        td:first-child {
            border-radius: 10px 0 0 10px;
        }
        td:last-child {
            border-radius: 0 10px 10px 0;
        }
        .ticker {
            font-weight: 800;
            font-size: 1.3em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .name {
            color: #666;
            font-size: 0.9em;
        }
        .price {
            font-weight: 700;
            font-size: 1.4em;
            color: #2c3e50;
        }
        .volume {
            color: #95a5a6;
            font-size: 0.95em;
        }
        .sparkline-container {
            width: 200px;
            height: 50px;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        tbody tr {
            animation: fadeIn 0.5s ease;
        }
    </style>
  </head>
  <body>
    <div id="app"></div>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script type="text/babel">

      const useState = React.useState;
      const useEffect = React.useEffect;
      const useRef = React.useRef;

      class PriceQueue {
          constructor(maxSize = 500) {
              this.maxSize = maxSize;
              this.data = [];
          }
          push(value) {
              this.data.push(value);
              if (this.data.length > this.maxSize) {
                  this.data.shift();
              }
          }
          getAll() {
              return [...this.data];
          }
      }

      function StockRow({ stockData, priceHistory, sparklineId }) {
          useEffect(() => {
              if (priceHistory.length > 1) {
                  d3.select(`#${sparklineId}`).select("svg").remove();
                  
                  const width = 200;
                  const height = 50;
                  const svg = d3.select(`#${sparklineId}`)
                      .append("svg")
                      .attr("width", width)
                      .attr("height", height);

                  const xScale = d3.scaleLinear()
                      .domain([0, priceHistory.length - 1])
                      .range([0, width]);

                  const yScale = d3.scaleLinear()
                      .domain([d3.min(priceHistory) * 0.98, d3.max(priceHistory) * 1.02])
                      .range([height, 0]);

                  const line = d3.line()
                      .x((d, i) => xScale(i))
                      .y(d => yScale(d))
                      .curve(d3.curveMonotoneX);

                  const area = d3.area()
                      .x((d, i) => xScale(i))
                      .y0(height)
                      .y1(d => yScale(d))
                      .curve(d3.curveMonotoneX);

                  const gradient = svg.append("defs")
                      .append("linearGradient")
                      .attr("id", `gradient-${sparklineId}`)
                      .attr("x1", "0%")
                      .attr("y1", "0%")
                      .attr("x2", "0%")
                      .attr("y2", "100%");

                  gradient.append("stop")
                      .attr("offset", "0%")
                      .attr("stop-color", "#667eea")
                      .attr("stop-opacity", 0.5);

                  gradient.append("stop")
                      .attr("offset", "100%")
                      .attr("stop-color", "#764ba2")
                      .attr("stop-opacity", 0.1);

                  svg.append("path")
                      .datum(priceHistory)
                      .attr("fill", `url(#gradient-${sparklineId})`)
                      .attr("d", area);

                  svg.append("path")
                      .datum(priceHistory)
                      .attr("fill", "none")
                      .attr("stroke", "#667eea")
                      .attr("stroke-width", 2)
                      .attr("d", line);

                  svg.append("circle")
                      .attr("cx", xScale(priceHistory.length - 1))
                      .attr("cy", yScale(priceHistory[priceHistory.length - 1]))
                      .attr("r", 4)
                      .attr("fill", "#764ba2");
              }
          }, [priceHistory, sparklineId]);

          return (
              <tr>
                  <td><div className="ticker">{stockData.ticker}</div></td>
                  <td><div className="name">{stockData.name}</div></td>
                  <td><div className="price">${stockData.price.toFixed(2)}</div></td>
                  <td><div className="volume">{stockData.volume.toLocaleString()}</div></td>
                  <td><div id={sparklineId} className="sparkline-container"></div></td>
              </tr>
          );
      }
      
      function App() {
          const [ibmData, setIbmData] = useState({ ticker: "IBM", name: "International Business Machines", price: 0, volume: 0 });
          const [amznData, setAmznData] = useState({ ticker: "AMZN", name: "Amazon", price: 0, volume: 0 });
          const [dowData, setDowData] = useState({ ticker: "DOW", name: "Dow Jones Industrial Average", price: 0, volume: 0 });
          const [nasdaqData, setNasdaqData] = useState({ ticker: "NASDAQ", name: "Nasdaq Composite", price: 0, volume: 0 });

          const ibmHistory = useRef(new PriceQueue(500));
          const amznHistory = useRef(new PriceQueue(500));
          const dowHistory = useRef(new PriceQueue(500));
          const nasdaqHistory = useRef(new PriceQueue(500));

          const [updateCounter, setUpdateCounter] = useState(0);

          useEffect(() => {
              const eventSource = new EventSource('http://localhost:31415/stocks');

              eventSource.onmessage = (event) => {
                  const stockData = JSON.parse(event.data);

                  switch(stockData.ticker) {
                      case 'IBM':
                          setIbmData(stockData);
                          ibmHistory.current.push(stockData.price);
                          break;
                      case 'AMZN':
                          setAmznData(stockData);
                          amznHistory.current.push(stockData.price);
                          break;
                      case 'DOW':
                          setDowData(stockData);
                          dowHistory.current.push(stockData.price);
                          break;
                      case 'NASDAQ':
                          setNasdaqData(stockData);
                          nasdaqHistory.current.push(stockData.price);
                          break;
                  }
                  
                  setUpdateCounter(prev => prev + 1);
              };

              return () => eventSource.close();
          }, []);

          return (
              <div>
                  <h1> Stock Dashboard</h1>
                  <table>
                      <thead>
                          <tr>
                              <th>Ticker</th>
                              <th>Name</th>
                              <th>Price</th>
                              <th>Volume</th>
                              <th>Trend</th>
                          </tr>
                      </thead>
                      <tbody>
                          <StockRow stockData={ibmData} priceHistory={ibmHistory.current.getAll()} sparklineId="ibm-spark" />
                          <StockRow stockData={amznData} priceHistory={amznHistory.current.getAll()} sparklineId="amzn-spark" />
                          <StockRow stockData={dowData} priceHistory={dowHistory.current.getAll()} sparklineId="dow-spark" />
                          <StockRow stockData={nasdaqData} priceHistory={nasdaqHistory.current.getAll()} sparklineId="nasdaq-spark" />
                      </tbody>
                  </table>
              </div>
          );
      }
      ReactDOM.render(<App />, document.getElementById('app'));
    </script>
  </body>
</html>